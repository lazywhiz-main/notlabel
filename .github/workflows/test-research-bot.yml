name: Test Research Bot

on:
  # æ‰‹å‹•å®Ÿè¡Œå°‚ç”¨
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰'
        required: true
        default: 'dry-run'
        type: choice
        options:
        - dry-run
        - test-post
        - full-test
      
      max_articles:
        description: 'å‡¦ç†ã™ã‚‹æœ€å¤§è¨˜äº‹æ•°'
        required: false
        default: '3'
        type: string

env:
  NODE_VERSION: '18'

jobs:
  test-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Validate environment setup
      run: |
        echo "ðŸ” ç’°å¢ƒå¤‰æ•°ã®ç¢ºèªä¸­..."
        
        # å¿…é ˆç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
        if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
          echo "âŒ OPENAI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        else
          echo "âœ… OPENAI_API_KEY è¨­å®šæ¸ˆã¿"
        fi
        
        if [ -z "${{ secrets.MICROCMS_API_KEY }}" ]; then
          echo "âŒ MICROCMS_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        else
          echo "âœ… MICROCMS_API_KEY è¨­å®šæ¸ˆã¿"
        fi
        
        if [ -z "${{ secrets.MICROCMS_SERVICE_DOMAIN }}" ]; then
          echo "âŒ MICROCMS_SERVICE_DOMAIN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        else
          echo "âœ… MICROCMS_SERVICE_DOMAIN è¨­å®šæ¸ˆã¿"
        fi
        
        # ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
        if [ -n "${{ secrets.TWITTER_API_KEY }}" ]; then
          echo "âœ… Twitter API è¨­å®šæ¸ˆã¿"
        else
          echo "âš ï¸ Twitter API æœªè¨­å®šï¼ˆGoogle Sheetsä½¿ç”¨ï¼‰"
        fi
        
        if [ -n "${{ secrets.WEBHOOK_URL }}" ]; then
          echo "âœ… Webhook URL è¨­å®šæ¸ˆã¿"
        else
          echo "âš ï¸ Webhook URL æœªè¨­å®š"
        fi
        
    - name: Setup test environment
      run: |
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
        echo "MICROCMS_API_KEY=${{ secrets.MICROCMS_API_KEY }}" >> $GITHUB_ENV
        echo "MICROCMS_SERVICE_DOMAIN=${{ secrets.MICROCMS_SERVICE_DOMAIN }}" >> $GITHUB_ENV
        echo "TWITTER_API_KEY=${{ secrets.TWITTER_API_KEY }}" >> $GITHUB_ENV
        echo "TWITTER_API_SECRET=${{ secrets.TWITTER_API_SECRET }}" >> $GITHUB_ENV
        echo "TWITTER_ACCESS_TOKEN=${{ secrets.TWITTER_ACCESS_TOKEN }}" >> $GITHUB_ENV
        echo "TWITTER_ACCESS_TOKEN_SECRET=${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}" >> $GITHUB_ENV
        echo "SITE_URL=${{ secrets.SITE_URL }}" >> $GITHUB_ENV
        echo "WEBHOOK_URL=${{ secrets.WEBHOOK_URL }}" >> $GITHUB_ENV
        echo "TEST_MODE=${{ github.event.inputs.test_mode }}" >> $GITHUB_ENV
        echo "MAX_ARTICLES=${{ github.event.inputs.max_articles }}" >> $GITHUB_ENV
        
    - name: Run template tests
      run: |
        echo "ðŸ§ª ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
        npm run bot:test || echo "âš ï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒç¶šè¡Œã—ã¾ã™"
        
    - name: Run bot test
      run: |
        echo "ðŸ¤– ãƒœãƒƒãƒˆã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
        echo "ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.test_mode }}"
        echo "æœ€å¤§è¨˜äº‹æ•°: ${{ github.event.inputs.max_articles }}"
        
        case "${{ github.event.inputs.test_mode }}" in
          "dry-run")
            echo "ðŸ” ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®æŠ•ç¨¿ãªã—ï¼‰"
            npm run bot:debug
            ;;
          "test-post")
            echo "ðŸ“ ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ãƒ¢ãƒ¼ãƒ‰ï¼ˆ1ä»¶ã®ã¿æŠ•ç¨¿ï¼‰"
            npm run bot
            ;;
          "full-test")
            echo "ðŸš€ ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰"
            npm run bot
            ;;
          *)
            echo "âŒ ä¸æ˜Žãªãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.test_mode }}"
            exit 1
            ;;
        esac
      env:
        TZ: Asia/Tokyo
        
    - name: Validate results
      if: always()
      run: |
        echo "ðŸ“Š å®Ÿè¡Œçµæžœã®æ¤œè¨¼ä¸­..."
        
        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if [ -f "bot.log" ]; then
          echo "âœ… ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
          echo "ðŸ“„ ãƒ­ã‚°ã®æœ€å¾Œã®10è¡Œ:"
          tail -10 bot.log
        else
          echo "âš ï¸ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
        
        # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç¢ºèª
        if [ -f "error.log" ]; then
          echo "âŒ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:"
          cat error.log
        else
          echo "âœ… ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“"
        fi
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ github.event.inputs.test_mode }}-${{ github.run_number }}
        path: |
          logs/
          *.log
          test-results/
        retention-days: 3
        
    - name: Test summary
      if: always()
      run: |
        echo "## ðŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰**: ${{ github.event.inputs.test_mode }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æœ€å¤§è¨˜äº‹æ•°**: ${{ github.event.inputs.max_articles }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… **ãƒ†ã‚¹ãƒˆçµæžœ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **ãƒ†ã‚¹ãƒˆçµæžœ**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "è©³ç´°ãªãƒ­ã‚°ã¯Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY 