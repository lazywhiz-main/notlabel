name: Test Bot Execution

on:
  # æ‰‹å‹•å®Ÿè¡Œå°‚ç”¨
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰'
        required: true
        default: 'env_check'
        type: choice
        options:
          - env_check
          - mock_run
          - real_run
      debug:
        description: 'ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›'
        required: false
        default: 'true'
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  test-bot:
    runs-on: ubuntu-latest
    environment: production  # ç’°å¢ƒã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Environment Check
      if: github.event.inputs.test_mode == 'env_check' || github.event.inputs.test_mode == 'mock_run' || github.event.inputs.test_mode == 'real_run'
      run: |
        echo "ğŸ” è©³ç´°ãªç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯"
        echo "========================================"
        
        # å¿…é ˆç’°å¢ƒå¤‰æ•°ã®ãƒã‚§ãƒƒã‚¯
        echo "ğŸ“‹ å¿…é ˆç’°å¢ƒå¤‰æ•°:"
        echo "OPENAI_API_KEY: $(if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then echo "âœ… è¨­å®šæ¸ˆã¿ (é•·ã•: ${#OPENAI_API_KEY})"; else echo "âŒ æœªè¨­å®š"; fi)"
        
        # microCMS APIã‚­ãƒ¼ã®è©³ç´°ãƒã‚§ãƒƒã‚¯
        if [ -n "${{ secrets.MICROCMS_API_KEY }}" ]; then
          MICROCMS_KEY="${{ secrets.MICROCMS_API_KEY }}"
          CLEAN_KEY=$(echo "$MICROCMS_KEY" | tr -d '\r\n\t' | xargs)
          echo "ğŸ”‘ microCMS API key length: ${#CLEAN_KEY}"
          echo "ğŸ” APIã‚­ãƒ¼å…ˆé ­10æ–‡å­—: ${CLEAN_KEY:0:10}..."
          if [[ "$CLEAN_KEY" =~ ^[a-zA-Z0-9\-_]+$ ]]; then
            echo "âœ… APIã‚­ãƒ¼å½¢å¼: æœ‰åŠ¹ãªæ–‡å­—ã®ã¿"
          else
            echo "âš ï¸  APIã‚­ãƒ¼å½¢å¼: ç„¡åŠ¹ãªæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§"
          fi
          echo "MICROCMS_API_KEY: âœ… è¨­å®šæ¸ˆã¿"
        else
          echo "MICROCMS_API_KEY: âŒ æœªè¨­å®š"
        fi
        
        echo "ğŸ  microCMS service domain: ${{ secrets.MICROCMS_SERVICE_DOMAIN }}"
        echo "MICROCMS_SERVICE_DOMAIN: $(if [ -n "${{ secrets.MICROCMS_SERVICE_DOMAIN }}" ]; then echo "âœ… è¨­å®šæ¸ˆã¿"; else echo "âŒ æœªè¨­å®š"; fi)"
        echo "SITE_URL: $(if [ -n "${{ secrets.SITE_URL }}" ]; then echo "âœ… è¨­å®šæ¸ˆã¿ (${{ secrets.SITE_URL }})"; else echo "âŒ æœªè¨­å®š"; fi)"
        
        echo ""
        echo "ğŸ¦ SNSé–¢é€£ç’°å¢ƒå¤‰æ•°:"
        echo "TWITTER_API_KEY: $(if [ -n "${{ secrets.TWITTER_API_KEY }}" ]; then echo "âœ… è¨­å®šæ¸ˆã¿"; else echo "âŒ æœªè¨­å®š"; fi)"
        echo "TWITTER_API_SECRET: $(if [ -n "${{ secrets.TWITTER_API_SECRET }}" ]; then echo "âœ… è¨­å®šæ¸ˆã¿"; else echo "âŒ æœªè¨­å®š"; fi)"
        echo "TWITTER_ACCESS_TOKEN: $(if [ -n "${{ secrets.TWITTER_ACCESS_TOKEN }}" ]; then echo "âœ… è¨­å®šæ¸ˆã¿"; else echo "âŒ æœªè¨­å®š"; fi)"
        echo "TWITTER_ACCESS_TOKEN_SECRET: $(if [ -n "${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}" ]; then echo "âœ… è¨­å®šæ¸ˆã¿"; else echo "âŒ æœªè¨­å®š"; fi)"
        
        echo ""
        echo "ğŸ“Š ãã®ä»–ã®è¨­å®š:"
        echo "SCORE_THRESHOLD: ${{ secrets.SCORE_THRESHOLD || 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ(4.0)' }}"
        echo "WEBHOOK_SHEETS_URL: $(if [ -n "${{ secrets.WEBHOOK_SHEETS_URL }}" ]; then echo "âœ… è¨­å®šæ¸ˆã¿"; else echo "âŒ æœªè¨­å®š"; fi)"
        
        echo ""
        echo "ğŸ’¡ Node.jsç’°å¢ƒ:"
        echo "Node.js: $(node --version)"
        echo "npm: $(npm --version)"
        echo "pwd: $(pwd)"
        
        echo ""
        echo "ğŸ“ é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª:"
        echo "src/bot/index.ts: $(if [ -f "src/bot/index.ts" ]; then echo "âœ… å­˜åœ¨"; else echo "âŒ ä¸åœ¨"; fi)"
        echo "package.json: $(if [ -f "package.json" ]; then echo "âœ… å­˜åœ¨"; else echo "âŒ ä¸åœ¨"; fi)"
        echo ".env: $(if [ -f ".env" ]; then echo "âœ… å­˜åœ¨"; else echo "âŒ ä¸åœ¨ï¼ˆActionsã§ã¯æ­£å¸¸ï¼‰"; fi)"
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        
    - name: Mock Bot Run (ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ)
      if: github.event.inputs.test_mode == 'mock_run'
      run: |
        echo "ğŸ§ª ãƒ¢ãƒƒã‚¯ãƒœãƒƒãƒˆå®Ÿè¡Œ"
        echo "========================================"
        
        # ç’°å¢ƒå¤‰æ•°è¨­å®š
        export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
        export MICROCMS_API_KEY="${{ secrets.MICROCMS_API_KEY }}"
        export MICROCMS_SERVICE_DOMAIN="${{ secrets.MICROCMS_SERVICE_DOMAIN }}"
        export SITE_URL="${{ secrets.SITE_URL }}"
        export SCORE_THRESHOLD="${{ secrets.SCORE_THRESHOLD || '4.0' }}"
        export DRY_RUN="true"
        
        echo "ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
        npm run bot:test 2>&1 | tee mock-execution.log
        
        echo ""
        echo "ğŸ“Š ãƒ¢ãƒƒã‚¯å®Ÿè¡Œçµæœ:"
        tail -20 mock-execution.log
        
    - name: Real Bot Run (æœ¬ç•ªå®Ÿè¡Œ)
      if: github.event.inputs.test_mode == 'real_run'
      run: |
        echo "ğŸš€ æœ¬ç•ªãƒœãƒƒãƒˆå®Ÿè¡Œ"
        echo "========================================"
        echo "âš ï¸  æ³¨æ„: å®Ÿéš›ã«microCMSã«è¨˜äº‹ãŒæŠ•ç¨¿ã•ã‚Œã¾ã™"
        
        # ç’°å¢ƒå¤‰æ•°è¨­å®š
        export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
        export MICROCMS_API_KEY="${{ secrets.MICROCMS_API_KEY }}"
        export MICROCMS_SERVICE_DOMAIN="${{ secrets.MICROCMS_SERVICE_DOMAIN }}"
        export TWITTER_API_KEY="${{ secrets.TWITTER_API_KEY }}"
        export TWITTER_API_SECRET="${{ secrets.TWITTER_API_SECRET }}"
        export TWITTER_ACCESS_TOKEN="${{ secrets.TWITTER_ACCESS_TOKEN }}"
        export TWITTER_ACCESS_TOKEN_SECRET="${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}"
        export SITE_URL="${{ secrets.SITE_URL }}"
        export WEBHOOK_SHEETS_URL="${{ secrets.WEBHOOK_SHEETS_URL }}"
        export SCORE_THRESHOLD="${{ secrets.SCORE_THRESHOLD || '4.0' }}"
        export TZ="Asia/Tokyo"
        
        echo "æœ¬ç•ªå®Ÿè¡Œé–‹å§‹..."
        npm run bot 2>&1 | tee real-execution.log
        
        echo ""
        echo "ğŸ“Š æœ¬ç•ªå®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼:"
        echo "å–å¾—è«–æ–‡æ•°:"
        grep "ä»¶ã®è«–æ–‡ã‚’å–å¾—" real-execution.log || echo "ãƒ­ã‚°ãªã—"
        echo "é…ä¿¡å¯¾è±¡:"
        grep "é…ä¿¡å¯¾è±¡" real-execution.log || echo "ãƒ­ã‚°ãªã—"
        echo "æŠ•ç¨¿å®Œäº†:"
        grep "æŠ•ç¨¿å®Œäº†" real-execution.log || echo "ãƒ­ã‚°ãªã—"
        echo "ã‚¨ãƒ©ãƒ¼:"
        grep -i "error\|ã‚¨ãƒ©ãƒ¼" real-execution.log || echo "ã‚¨ãƒ©ãƒ¼ãªã—"
        
    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-execution-logs-${{ github.run_number }}-${{ github.event.inputs.test_mode }}
        path: |
          *-execution.log
          logs/
          *.log
        retention-days: 30
        
    - name: Test Summary
      if: always()
      run: |
        echo "ğŸ“‹ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚µãƒãƒªãƒ¼"
        echo "========================================"
        echo "ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.test_mode }}"
        echo "å®Ÿè¡Œæ™‚åˆ»: $(date)"
        echo "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${{ job.status }}"
        
        if [ "${{ github.event.inputs.test_mode }}" = "env_check" ]; then
          echo "âœ… ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"
        elif [ "${{ github.event.inputs.test_mode }}" = "mock_run" ]; then
          echo "âœ… ãƒ¢ãƒƒã‚¯å®Ÿè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸ"
        elif [ "${{ github.event.inputs.test_mode }}" = "real_run" ]; then
          echo "âœ… æœ¬ç•ªå®Ÿè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸ"
        fi 